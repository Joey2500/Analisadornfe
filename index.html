<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Leitor NF-e com Hist√≥rico</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #f5f5f5; --text: #0a0a0a; --border: #0a0a0a; --accent-1: #ffff00;
            --accent-2: #00ffff; --shadow: #0a0a0a; --btn-text: #0a0a0a; --danger: #ff4136;
        }
        body.dark-theme {
            --bg: #0a0a0a; --text: #f5f5f5; --border: #f5f5f5; --accent-1: #00ff00;
            --accent-2: #ff00ff; --shadow: #f5f5f5; --btn-text: #0a0a0a;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Roboto Mono', monospace; max-width: 1000px; margin: 20px auto; padding: 20px; border: 2px solid var(--border); }
        h1, h2 { font-weight: 700; text-transform: uppercase; background-color: var(--accent-1); color: var(--btn-text); border: 2px solid var(--border); padding: 10px; display: inline-block; margin-top: 30px; }
        h1 { margin-top: 0; }
        .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header-container h1 { margin-right: auto; }
        .btn { display: inline-block; padding: 12px 25px; background: var(--accent-1); color: var(--btn-text); border: 2px solid var(--border); font-weight: 700; font-size: 16px; text-align: center; cursor: pointer; box-shadow: 4px 4px 0px var(--shadow); transition: transform 0.1s ease, box-shadow 0.1s ease; text-transform: uppercase; margin-bottom: 10px; }
        .btn:not(:last-child) { margin-right: 10px; }
        .btn:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--shadow); }
        .btn:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--shadow); }
        .btn:disabled { background-color: #ccc; color: #888; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-danger { background-color: var(--danger); color: white; }
        input[type="file"] { display: none; }
        #messages { text-align: center; margin: 30px 0; font-weight: bold; font-size: 18px; color: var(--text); background-color: var(--bg); border: 2px dashed var(--border); padding: 15px; }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; border: 2px solid var(--border); }
        th, td { padding: 12px 15px; border: 2px solid var(--border); text-align: left; }
        thead th { background: var(--accent-1); color: var(--btn-text); text-transform: uppercase; font-size: 13px; }
        tfoot th { font-weight: 700; color: var(--text); border-top: 4px solid var(--border); }
        .valor, .percent { text-align: right; font-weight: 700; }
        .chart-container { border: 2px solid var(--border); padding: 20px; margin: 20px auto 40px; max-width: 1000px; box-shadow: 4px 4px 0px var(--shadow); }
        .tab-nav { display: flex; gap: 10px; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .tab-nav .btn { box-shadow: none; border-bottom: none; margin-bottom: 0; }
        .tab-nav .btn.active { background-color: var(--accent-2); transform: none; cursor: default; }
        .tab-content { display: none; background-color: var(--bg); }
        .tab-content.active { display: block; }
        .input-group { margin: 20px 0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .input-group label { font-weight: bold; }
        .input-group input[type="month"] { padding: 10px; border: 2px solid var(--border); background-color: var(--bg); color: var(--text); font-family: 'Roboto Mono', monospace; font-size: 16px; }
        .history-actions { margin-top: 20px; border-top: 2px solid var(--border); padding-top: 20px; display: flex; flex-wrap: wrap; justify-content: flex-start; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>Leitor de NF-e</h1>
        <div>
            <button id="screenshot-btn" class="btn">üì∏ Capturar Tela</button>
            <button id="theme-toggle" class="btn">Mudar Tema</button>
        </div>
    </div>

    <div class="tab-nav">
        <button class="btn active" data-tab="tab-analise">An√°lise NF-e</button>
        <button class="btn" data-tab="tab-historico">Hist√≥rico</button>
    </div>

    <div id="tab-analise" class="tab-content active">
        <div class="input-group">
            <label for="zip-file" class="btn">üìÇ Selecionar ZIP</label>
            <input type="file" id="zip-file" accept=".zip" />
            <label for="month-input">M√™s de Refer√™ncia:</label>
            <input type="month" id="month-input">
            <button id="save-history-btn" class="btn" disabled>Salvar no Hist√≥rico</button>
        </div>
        <div id="messages">Aguardando arquivo...</div>
        <h2>‚úÖ Mercadoria</h2>
        <table id="tbl-merch">
            <thead><tr><th>Documento</th><th>Chave NF-e</th><th>CFOP</th><th class="valor">Valor (R$)</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th colspan="3">TOTAL MERCADORIA</th><th class="valor" id="total-merch">R$ 0,00</th></tr></tfoot>
        </table>
        <h2>üõ†Ô∏è M√£o de Obra</h2>
        <table id="tbl-lab">
            <thead><tr><th>Documento</th><th>Chave NF-e</th><th>CFOP</th><th class="valor">Valor (R$)</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th colspan="3">TOTAL M√ÉO DE OBRA</th><th class="valor" id="total-lab">R$ 0,00</th></tr></tfoot>
        </table>
        <h2>üìä Distribui√ß√£o por CFOP</h2>
        <div class="chart-container"><canvas id="cfopChart"></canvas></div>
    </div>

    <div id="tab-historico" class="tab-content">
        <h2>üóìÔ∏è Hist√≥rico Mensal</h2>
        <table id="history-table">
            <thead>
                <tr>
                    <th>M√™s/Ano</th>
                    <th class="valor">Total Mercadoria (R$)</th>
                    <th class="percent">Var. Merc. (%)</th>
                    <th class="valor">Total M√£o de Obra (R$)</th>
                    <th class="percent">Var. M. Obra (%)</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <th>TOTAL CONSOLIDADO</th>
                    <th class="valor" id="history-total-merch">R$ 0,00</th>
                    <th class="percent">‚Äî</th>
                    <th class="valor" id="history-total-lab">R$ 0,00</th>
                    <th class="percent">‚Äî</th>
                </tr>
            </tfoot>
        </table>
        <h2>üìà Evolu√ß√£o da Mercadoria</h2>
        <div class="chart-container"><canvas id="history-chart-merch"></canvas></div>
        <h2>üõ†Ô∏è Evolu√ß√£o da M√£o de Obra</h2>
        <div class="chart-container"><canvas id="history-chart-lab"></canvas></div>
        <div class="history-actions">
            <button id="export-history-btn" class="btn">Exportar Hist√≥rico</button>
            <label for="import-history-input" class="btn">Importar Hist√≥rico</label>
            <input type="file" id="import-history-input" accept=".json">
            <button id="clear-history-btn" class="btn btn-danger">Limpar Hist√≥rico</button>
        </div>
    </div>

    <script>
        // --- 1. VARI√ÅVEIS GLOBAIS ---
        let totalMerch = 0, totalLab = 0;
        let cfopChart, merchHistoryChartInstance, labHistoryChartInstance;
        
        // --- 2. CONSTANTES DE ELEMENTOS DO DOM ---
        const saveHistoryBtn = document.getElementById('save-history-btn');
        const monthInput = document.getElementById('month-input');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const zipFileInput = document.getElementById('zip-file');
        const exportHistoryBtn = document.getElementById('export-history-btn');
        const importHistoryInput = document.getElementById('import-history-input');
        const screenshotBtn = document.getElementById('screenshot-btn');
        const tabButtons = document.querySelectorAll('.tab-nav .btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const msg = t => document.getElementById('messages').textContent = t;

        // --- 3. DEFINI√á√ÉO DE FUN√á√ïES ---
        
        function getHistory() { const historyJSON = localStorage.getItem('nfeHistory'); return historyJSON ? JSON.parse(historyJSON) : []; }
        function saveHistory(data) { data.sort((a, b) => a.month.localeCompare(b.month)); localStorage.setItem('nfeHistory', JSON.stringify(data)); }

        function renderHistoryTab() { const history = getHistory(); const tbody = document.querySelector('#history-table tbody'); tbody.innerHTML = ''; if (history.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum dado no hist√≥rico.</td></tr>'; document.getElementById('history-total-merch').textContent = 'R$ 0,00'; document.getElementById('history-total-lab').textContent = 'R$ 0,00'; if (merchHistoryChartInstance) merchHistoryChartInstance.destroy(); if (labHistoryChartInstance) labHistoryChartInstance.destroy(); return; } let consolidatedMerch = 0, consolidatedLab = 0; history.forEach((entry, index) => { const tr = document.createElement('tr'); consolidatedMerch += entry.mercadoria; consolidatedLab += entry.maoDeObra; let merchGrowthCell = '‚Äî'; let labGrowthCell = '‚Äî'; if (index > 0) { const prevEntry = history[index - 1]; if (prevEntry.mercadoria > 0) { const variacao = ((entry.mercadoria - prevEntry.mercadoria) / prevEntry.mercadoria) * 100; const cor = variacao >= 0 ? 'green' : 'red'; merchGrowthCell = `<span style="color:${cor}">${variacao.toFixed(2).replace('.',',')}%</span>`; } if (prevEntry.maoDeObra > 0) { const variacao = ((entry.maoDeObra - prevEntry.maoDeObra) / prevEntry.maoDeObra) * 100; const cor = variacao >= 0 ? 'green' : 'red'; labGrowthCell = `<span style="color:${cor}">${variacao.toFixed(2).replace('.',',')}%</span>`; } } tr.innerHTML = `<td>${entry.month.replace('-', '/')}</td><td class="valor">${entry.mercadoria.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="percent">${merchGrowthCell}</td><td class="valor">${entry.maoDeObra.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="percent">${labGrowthCell}</td>`; tbody.appendChild(tr); }); document.getElementById('history-total-merch').textContent = consolidatedMerch.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); document.getElementById('history-total-lab').textContent = consolidatedLab.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); renderMerchHistoryChart(history); renderLabHistoryChart(history); }
        function renderMerchHistoryChart(history) { const ctx = document.getElementById('history-chart-merch').getContext('2d'); if (merchHistoryChartInstance) merchHistoryChartInstance.destroy(); const isDark = document.body.classList.contains('dark-theme'); const accent1 = isDark ? '#00ff00' : '#ffff00'; const textColor = isDark ? '#f5f5f5' : '#0a0a0a'; merchHistoryChartInstance = new Chart(ctx, { type: 'line', data: { labels: history.map(e => e.month.replace('-', '/')), datasets: [{ label: 'Mercadoria (R$)', data: history.map(e => e.mercadoria), borderColor: accent1, backgroundColor: accent1 + '33', tension: 0.1, fill: true }] }, options: { scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } } } } }); }
        function renderLabHistoryChart(history) { const ctx = document.getElementById('history-chart-lab').getContext('2d'); if (labHistoryChartInstance) labHistoryChartInstance.destroy(); const isDark = document.body.classList.contains('dark-theme'); const accent2 = isDark ? '#ff00ff' : '#00ffff'; const textColor = isDark ? '#f5f5f5' : '#0a0a0a'; labHistoryChartInstance = new Chart(ctx, { type: 'line', data: { labels: history.map(e => e.month.replace('-', '/')), datasets: [{ label: 'M√£o de Obra (R$)', data: history.map(e => e.maoDeObra), borderColor: accent2, backgroundColor: accent2 + '33', tension: 0.1, fill: true }] }, options: { scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } } } } }); }
        
        function processXML(xmlText) { const xml = new DOMParser().parseFromString(xmlText, "application/xml"); let nNF = xml.querySelector("nNF")?.textContent || "‚Äî"; const chave = xml.querySelector("chNFe")?.textContent || xml.querySelector("[Id^='NFe']")?.getAttribute("Id") || "‚Äî"; const cStat = xml.querySelector("cStat")?.textContent; const xMotivo = xml.querySelector("xMotivo")?.textContent?.toLowerCase() || ""; const cancelada = cStat === "101" || cStat === "135" || xMotivo.includes("cancel"); if (cancelada) nNF += " (CANCELADA)"; xml.querySelectorAll("det").forEach(det => { const cfop = det.querySelector("CFOP")?.textContent.trim(); const vProd = parseFloat(det.querySelector("vProd")?.textContent || "0"); if (cfop === "6902") { addRow("tbl-merch", nNF, chave, "6902", vProd); if (!cancelada) totalMerch += vProd; } if (cfop === "6124") { addRow("tbl-lab", nNF, chave, "6124", vProd); if (!cancelada) totalLab += vProd; } }); updateTotals(); return true; }
        function addRow(tableId, nNF, chave, cfop, valorFloat) { const tbody = document.querySelector(`#${tableId} tbody`); if (!tbody) { console.error(`Falha ao encontrar o tbody para a tabela #${tableId}`); return; } const valor = valorFloat.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); const tr = document.createElement("tr"); tr.innerHTML = `<td>${nNF}</td><td>${chave}</td><td>${cfop}</td><td class="valor">R$ ${valor}</td>`; tbody.appendChild(tr); }
        function updateTotals() { document.getElementById("total-merch").textContent = "R$ " + totalMerch.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); document.getElementById("total-lab").textContent = "R$ " + totalLab.toLocaleString('pt-BR', { minimumFractionDigits: 2 }); cfopChart.data.datasets[0].data = [totalMerch, totalLab]; cfopChart.update(); }

        function applyTheme(theme) { const isDark = theme === 'dark'; document.body.classList.toggle('dark-theme', isDark); if (cfopChart) updateChartColors(); if (document.getElementById('tab-historico').classList.contains('active')) renderHistoryTab(); };
        function updateChartColors() { if (!cfopChart) return; const isDark = document.body.classList.contains('dark-theme'); const colors = isDark ? ['#00ff00', '#ff00ff'] : ['#ffff00', '#00ffff']; const borderColor = isDark ? '#f5f5f5' : '#0a0a0a'; const textColor = isDark ? '#f5f5f5' : '#0a0a0a'; cfopChart.data.datasets[0].backgroundColor = colors; cfopChart.data.datasets[0].borderColor = borderColor; cfopChart.options.plugins.legend.labels.color = textColor; cfopChart.update(); }

        // --- 4. EVENT LISTENERS ---
        tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active'); const targetTab = button.getAttribute('data-tab'); document.getElementById(targetTab).classList.add('active'); if (targetTab === 'tab-historico') { renderHistoryTab(); } }); });
        saveHistoryBtn.addEventListener('click', () => { const month = monthInput.value; if (!month) { alert("Por favor, selecione o M√™s de Refer√™ncia antes de salvar."); return; } if (totalMerch === 0 && totalLab === 0) { alert("N√£o h√° dados processados para salvar."); return; } const history = getHistory(); const existingEntryIndex = history.findIndex(entry => entry.month === month); const newEntry = { month, mercadoria: totalMerch, maoDeObra: totalLab }; if (existingEntryIndex > -1) { if (confirm(`J√° existem dados para ${month}. Deseja sobrescrev√™-los?`)) { history[existingEntryIndex] = newEntry; } else { return; } } else { history.push(newEntry); } saveHistory(history); alert(`Dados de ${month} salvos com sucesso!`); renderHistoryTab(); });
        clearHistoryBtn.addEventListener('click', () => { if (confirm("TEM CERTEZA? Todo o hist√≥rico ser√° apagado permanentemente.")) { localStorage.removeItem('nfeHistory'); renderHistoryTab(); alert("Hist√≥rico apagado."); } });
        exportHistoryBtn.addEventListener('click', () => { const history = getHistory(); if (history.length === 0) { alert('N√£o h√° hist√≥rico para exportar.'); return; } const jsonString = JSON.stringify(history, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const today = new Date().toISOString().slice(0, 10); a.href = url; a.download = `historico-nfe-${today}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
        importHistoryInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (!Array.isArray(importedData) || (importedData.length > 0 && !importedData[0].month)) { throw new Error('O conte√∫do do arquivo n√£o parece ser um hist√≥rico v√°lido.'); } if (confirm('Isso ir√° SOBRESCREVER todo o seu hist√≥rico atual com os dados do arquivo. Deseja continuar?')) { saveHistory(importedData); renderHistoryTab(); alert('Hist√≥rico importado com sucesso!'); } } catch (error) { alert(`Erro ao importar o arquivo: ${error.message}`); } finally { importHistoryInput.value = ''; } }; reader.readAsText(file); });
        zipFileInput.addEventListener('change', async e => { const file = e.target.files[0]; if (!file) return; msg("‚è≥ Lendo arquivo..."); totalMerch = 0; totalLab = 0; document.querySelectorAll("#tbl-merch tbody, #tbl-lab tbody").forEach(tb => tb.innerHTML = ""); saveHistoryBtn.disabled = true; try { const zip = await JSZip.loadAsync(file); const entries = Object.values(zip.files); let total = 0; for (const entry of entries) { if (!entry.dir && entry.name.toLowerCase().endsWith(".xml")) { const xmlText = await entry.async("text"); if (processXML(xmlText)) total++; } } msg(`‚úîÔ∏è ${total} NF-e v√°lidas processadas.`); if (total > 0) saveHistoryBtn.disabled = false; } catch (err) { console.error("Erro ao processar o ZIP:", err); msg(`‚ùå Erro ao processar o arquivo: ${err.message}`); } });
        themeToggle.addEventListener('click', () => { const isDark = document.body.classList.toggle('dark-theme'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateChartColors(); if (document.getElementById('tab-historico').classList.contains('active')) renderHistoryTab(); });
        screenshotBtn.addEventListener('click', () => { const activeTabContent = document.querySelector('.tab-content.active'); if (!activeTabContent) { alert('Nenhuma aba ativa encontrada para capturar.'); return; } const originalText = screenshotBtn.textContent; screenshotBtn.textContent = 'Capturando...'; screenshotBtn.disabled = true; const originalChartAnimation = Chart.defaults.animation; Chart.defaults.animation = false; html2canvas(activeTabContent, { scale: 2, useCORS: true, backgroundColor: document.body.classList.contains('dark-theme') ? '#0a0a0a' : '#f5f5f5' }).then(canvas => { const a = document.createElement('a'); const today = new Date().toISOString().slice(0, 10); const activeTabId = activeTabContent.id.replace('tab-', ''); a.href = canvas.toDataURL('image/png'); a.download = `captura-${activeTabId}-${today}.png`; a.click(); }).catch(err => { console.error("Erro ao capturar a tela:", err); alert("Ocorreu um erro ao tentar capturar a tela."); }).finally(() => { Chart.defaults.animation = originalChartAnimation; screenshotBtn.textContent = originalText; screenshotBtn.disabled = false; }); });
        
        // --- 5. FUN√á√ÉO DE INICIALIZA√á√ÉO ---
        function initializeApp() {
            monthInput.value = new Date().toISOString().slice(0, 7);
            const cfopCtx = document.getElementById('cfopChart').getContext('2d');
            cfopChart = new Chart(cfopCtx, { type: 'pie', data: { labels: ['Mercadoria (6902)', 'M√£o de Obra (6124)'], datasets: [{ data: [0, 0], borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { family: "'Roboto Mono', monospace", size: 14 } } } } }, plugins: [{ id: 'centerText', afterDraw(chart) { const {ctx, chartArea, width} = chart; const [merc, mao] = chart.data.datasets[0].data; if (!merc || isNaN(mao) || merc === 0) return; const percent = ((mao / merc) * 100).toFixed(2).replace('.', ',') + '%'; const label = `M√£o de Obra: ${percent}`; ctx.save(); ctx.font = `bold ${Math.floor(width / 20)}px 'Roboto Mono'`; ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#f5f5f5' : '#0a0a0a'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(label, (chartArea.left + chartArea.right) / 2, (chartArea.top + chartArea.bottom) / 2); ctx.restore(); } }] });
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        // --- 6. IN√çCIO DA EXECU√á√ÉO ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
